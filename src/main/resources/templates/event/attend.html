<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrap.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
    <div class="container-md" id="attend">
        <div class="attend-effect">
            <div class="attend-title">ì¶œì„ì²´í¬</div>
            <div class="attend-container">
                <div class="node-grid">
                    <!-- ê° ë…¸ë“œ -->
                    <div class="node" data-index="1">ì¶œì„</div>
                    <div class="node" data-index="2">ì¶œì„</div>
                    <div class="node gift" data-index="5">ë‹¹ì²¨</div>
                    <!-- ... -->
                    <div class="node gift" data-index="30">ë‹¹ì²¨</div>
                </div>
            </div>
        </div>

        <div class="reward-container">
            <div class="reward-title">ë‹¹ì²¨ ìƒí’ˆ</div>
            <div class="reward-box">
                <img src="/img/giftcon_450_red.png">
            </div>
            <div class="reward-content">ìƒí’ˆê¶Œ 10,000ì›</div>
        </div>

        <div class="attend-notes">
            <div class="attend-bold">ì°¸ê³ ì‚¬í•­</div>
            <br>
            <div class="attend-bold">* ì¶œì„ì²´í¬ëŠ” ê³„ì •ë‹¹ í•˜ë£¨ì— í•œ ë²ˆë§Œ ì´ìš© ê°€ëŠ¥í•´ìš”.</div>
            <div class="attend-bold">* ë‹¹ì²¨ì´ ë˜ì…¨ì„ ê²½ìš°ì—ëŠ” [ë§ˆì´] -> [ë‚´ ì •ë³´] -> [ë‹¹ì²¨ ë‚´ì—­]ì„ í†µí•´ì„œ ë‹¹ì²¨ì„ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆì–´ìš”.</div>
            <div class="attend-bold">* ë‹¹ì²¨ëœ ìƒí’ˆì€ ì‚¬ìš© ê¸°í•œì´ ìˆìœ¼ë©°, ê¸°í•œ ì—°ì¥ì€ ì–´ë ¤ìš°ë‹ˆ ê¸°í•œ ì•ˆì— ì‚¬ìš©í•´ì•¼ í•´ìš”.</div>
        </div>
    </div>

    <div id="custom-alert" class="event-modal">
        <div class="event-modalContent">
            <p id="alert-message"></p>
            <hr class="event-divider">
            <button id="alert-ok-button">í™•ì¸</button>
        </div>
    </div>

    <script>
        const NODES_TOTAL = 30;
        const GIFT_INTERVAL = 5;

        // ì°¸ì—¬ ì—¬ë¶€ë¥¼ ì„œë²„ì—ì„œ í™•ì¸
        const checkParticipation = async () => {
            try {
                const response = await fetch("/event/checkAttend");
                const data = await response.json();
                return data.alreadyParticipated;
            } catch (error) {
                console.error("ì°¸ì—¬ ì—¬ë¶€ í™•ì¸ ì‹¤íŒ¨:", error);
                return false; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ì€ "ì°¸ì—¬ ê°€ëŠ¥"
            }
        };

        // ì¶œì„ì²´í¬í•œ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        const getCompletedAttendance = async () => {
            try {
                const response = await fetch("/event/attendCount", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();
                return data.attendCount; // attendCount ê°’ì„ ë°˜í™˜
            } catch (error) {
                console.error("ì¶œì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                return 0; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ì€ 0
            }
        };

        const generateAttendanceNodes = async () => {
            const container = document.querySelector('.attend-container .node-grid');
            container.innerHTML = '';

            const completedCount = await getCompletedAttendance(); // ì´ë¯¸ ì™„ë£Œëœ ì¶œì„ íšŸìˆ˜ ê°€ì ¸ì˜¤ê¸°

            for (let i = 1; i <= NODES_TOTAL; i++) {
                const node = document.createElement('div');
                node.classList.add('node');
                node.dataset.index = i; // ë°ì´í„° ì¸ë±ìŠ¤ ì¶”ê°€

                if (i % GIFT_INTERVAL === 0) {
                    node.classList.add('gift');
                    node.textContent = 'ë‹¹ì²¨';
                } else {
                    node.textContent = `ì¶œì„`; // ì¶œì„ ì¼ìˆ˜ í‘œì‹œ
                }

                // ì´ë¯¸ ì¶œì„ ì™„ë£Œí•œ ë„ì¥ì€ 'completed' í´ë˜ìŠ¤ ì¶”ê°€
                if (i <= completedCount) {
                    node.classList.add('completed');
                }

                // ë§ˆì§€ë§‰ ì¶œì„ ë…¸ë“œ ë°”ë¡œ ë‹¤ìŒ ë…¸ë“œë§Œ í´ë¦­ ê°€ëŠ¥
                if (i > completedCount + 1) {
                    node.classList.add('disabled'); // ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼ ì¶”ê°€
                }

                container.appendChild(node);
            }
        };

        // ì¶œì„ì²´í¬ ì‹œì‘ í•¨ìˆ˜
        const startAttendanceCheck = async (index) => {
            const alreadyParticipated = await checkParticipation();

            if (alreadyParticipated) {
                showAlert("í•˜ë£¨ì— í•œ ë²ˆë§Œ ì¶œì„ ê°€ëŠ¥í•©ë‹ˆë‹¤.");
                return; // ì´ë¯¸ ì¶œì„í•œ ê²½ìš° ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
            }

            markAttendance(index); // ì¶œì„ ì²´í¬
        };

        // ì¶œì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
        const markAttendance = async (index) => {
            const target = document.querySelector(`[data-index="${index}"]`);
            target.classList.add('completed');
            showAlert("ì¶œì„ ì™„ë£Œ!");

            // ì„œë²„ë¡œ ì¶œì„ ì²´í¬ ê²°ê³¼ ì „ì†¡
            fetch('/event/attend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.gift) {
                        showAlert("ğŸ‰ ê¸°í”„í‹°ì½˜ ì§€ê¸‰ ì™„ë£Œ!");
                    }
                })
                .catch((err) => console.error("ì„œë²„ ì˜¤ë¥˜:", err));
        };

        // í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelector('.attend-container .node-grid').addEventListener('click', (e) => {
            const target = e.target;

            // í´ë¦­ ê°€ëŠ¥ ì¡°ê±´ ì¶”ê°€
            if (target.classList.contains('node') &&
                !target.classList.contains('completed') &&
                !target.classList.contains('disabled')) {
                const index = parseInt(target.dataset.index, 10);
                startAttendanceCheck(index); // ì¶œì„ ì‹œì‘
            } else {
                showAlert("ì¶œì„ë„ì¥ì„ ì°¨ë¡€ëŒ€ë¡œ ì°ì–´ì£¼ì„¸ìš”");
            }
        });

        const init = async () => {
            await generateAttendanceNodes();
        };

        init();

        // ëª¨ë‹¬ DOM ìš”ì†Œ
        const customAlert = document.getElementById("custom-alert");
        const alertMessage = document.getElementById("alert-message");
        const alertOkButton = document.getElementById("alert-ok-button");

        // ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆëœ alert í•¨ìˆ˜
        const showAlert = (message) => {
          alertMessage.textContent = message;
          customAlert.classList.remove("hidden");
          customAlert.style.display = "block";
        };

        // "í™•ì¸" ë²„íŠ¼ í´ë¦­ ì‹œ ëª¨ë‹¬ ë‹«ê¸°
        alertOkButton.addEventListener("click", () => {
          customAlert.classList.add("hidden");
          customAlert.style.display = "none";
        });
    </script>
</div>