<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultrap.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<div layout:fragment="content">
    <div class="container-md" id="attend">
        <h2>ì¶œì„ì²´í¬ ì´ë²¤íŠ¸</h2>
        <div class="attend-container">
            <div class="node-grid">
                <!-- ê° ë…¸ë“œ -->
                <div class="node" data-index="1">ì¶œì„</div>
                <div class="node" data-index="2">ì¶œì„</div>
                <div class="node gift" data-index="5">ê¸°í”„í‹°ì½˜</div>
                <!-- ... -->
                <div class="node gift" data-index="30">ê¸°í”„í‹°ì½˜</div>
            </div>
        </div>
    </div>
    <script>
        const NODES_TOTAL = 30;
        const GIFT_INTERVAL = 5;

        // ì°¸ì—¬ ì—¬ë¶€ë¥¼ ì„œë²„ì—ì„œ í™•ì¸
        const checkParticipation = async () => {
            try {
                const response = await fetch("/event/checkAttend");
                const data = await response.json();
                return data.alreadyParticipated;
            } catch (error) {
                console.error("ì°¸ì—¬ ì—¬ë¶€ í™•ì¸ ì‹¤íŒ¨:", error);
                return false; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ì€ "ì°¸ì—¬ ê°€ëŠ¥"
            }
        };

        // ì¶œì„ì²´í¬í•œ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
        const getCompletedAttendance = async () => {
            try {
                const response = await fetch("/event/attendCount", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                const data = await response.json();
                return data.attendCount; // attendCount ê°’ì„ ë°˜í™˜
            } catch (error) {
                console.error("ì¶œì„ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:", error);
                return 0; // ì‹¤íŒ¨ ì‹œ ê¸°ë³¸ê°’ì€ 0
            }
        };

        const generateAttendanceNodes = async () => {
            const container = document.querySelector('.attend-container .node-grid');
            container.innerHTML = '';

            const completedCount = await getCompletedAttendance(); // ì´ë¯¸ ì™„ë£Œëœ ì¶œì„ íšŸìˆ˜ ê°€ì ¸ì˜¤ê¸°

            for (let i = 1; i <= NODES_TOTAL; i++) {
                const node = document.createElement('div');
                node.classList.add('node');
                node.dataset.index = i; // ë°ì´í„° ì¸ë±ìŠ¤ ì¶”ê°€

                if (i % GIFT_INTERVAL === 0) {
                    node.classList.add('gift');
                    node.textContent = 'ê¸°í”„í‹°ì½˜';
                } else {
                    node.textContent = `ì¶œì„`; // ì¶œì„ ì¼ìˆ˜ í‘œì‹œ
                }

                // ì´ë¯¸ ì¶œì„ ì™„ë£Œí•œ ë„ì¥ì€ 'completed' í´ë˜ìŠ¤ ì¶”ê°€
                if (i <= completedCount) {
                    node.classList.add('completed');
                }

                container.appendChild(node);
            }
        };

        // ì¶œì„ì²´í¬ ì‹œì‘ í•¨ìˆ˜
        const startAttendanceCheck = async (index) => {
            const alreadyParticipated = await checkParticipation();

            if (alreadyParticipated) {
                alert("í•˜ë£¨ì— í•œ ë²ˆë§Œ ì¶œì„í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return; // ì´ë¯¸ ì¶œì„í•œ ê²½ìš° ë” ì´ìƒ ì§„í–‰í•˜ì§€ ì•ŠìŒ
            }

            markAttendance(index); // ì¶œì„ ì²´í¬
        };

        // ì¶œì„ ì²˜ë¦¬í•˜ëŠ” í•¨ìˆ˜
        const markAttendance = async (index) => {
            const target = document.querySelector(`[data-index="${index}"]`);
            target.classList.add('completed');
            alert("ì¶œì„ ì™„ë£Œ!");

            // ì„œë²„ë¡œ ì¶œì„ ì²´í¬ ê²°ê³¼ ì „ì†¡
            fetch('/event/attend', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ index }),
            })
                .then((res) => res.json())
                .then((data) => {
                    if (data.gift) {
                        alert("ğŸ‰ ê¸°í”„í‹°ì½˜ ì§€ê¸‰ ì™„ë£Œ!");
                    }
                })
                .catch((err) => console.error("ì„œë²„ ì˜¤ë¥˜:", err));
        };

        // í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.querySelector('.attend-container .node-grid').addEventListener('click', (e) => {
            const target = e.target;

            if (target.classList.contains('node') && !target.classList.contains('completed')) {
                const index = target.dataset.index;
                startAttendanceCheck(index); // ì¶œì„ ì‹œì‘
            }
        });

        const init = async () => {
            const completedCount = await getCompletedAttendance(); // ì™„ë£Œëœ ì¶œì„ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
            generateAttendanceNodes(completedCount); // ë…¸ë“œ ìƒì„± ë° ì™„ë£Œëœ ì¶œì„ í‘œì‹œ
        };

        init();

    </script>
</div>